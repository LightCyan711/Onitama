<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ë‹ˆíƒ€ë§ˆ AI (ONNX) ğŸ¥‹</title>
    <link rel="stylesheet" href="style.css">
    <!-- ONNX Runtime Web -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        .onnx-badge {
            background-color: #6f42c1;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            vertical-align: middle;
            margin-left: 10px;
        }
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5em;
            z-index: 1000;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="hidden">
        AI ëª¨ë¸ ë¡œë”© ì¤‘... ğŸ¤–
    </div>

    <div class="container">
        <header>
            <h1>ğŸ¥‹ ì˜¤ë‹ˆíƒ€ë§ˆ AI</h1>
            <p class="subtitle">ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤ë©´ ìƒˆ ê²Œì„ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”</p> <!-- Updated subtitle -->
        </header>

        <div id="panel-play" class="panel">
            <div class="player-info">
                <div class="center-card" id="center-card"></div>
            </div>
            
            <div class="game-area">
                <canvas id="canvas-play" width="350" height="350"></canvas>
            </div>

            <div class="player-info">
                <div class="player-cards" id="player-cards">
                    <div class="card-label">ë‚´ ì¹´ë“œ (í´ë¦­í•˜ì—¬ ì„ íƒ)</div>
                    <div class="cards-holder"></div>
                </div>
            </div>

            <div class="game-status">
                <div id="turn-indicator">ê²Œì„ ì¤€ë¹„ ì¤‘...</div>
                <div class="help-text">
                    ğŸ’¡ <strong>í”Œë ˆì´ ë°©ë²•:</strong><br>
                    1ï¸âƒ£ ì•„ë˜ ì¹´ë“œ ì¤‘ í•˜ë‚˜ë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒ<br>
                    2ï¸âƒ£ ë¹¨ê°„ ë§ì„ í´ë¦­<br>
                    3ï¸âƒ£ ì´ˆë¡ìƒ‰ ì›(ì´ë™ ê°€ëŠ¥ ìœ„ì¹˜)ì„ í´ë¦­í•˜ì—¬ ì´ë™
                </div>
                <button id="btn-new-game" class="btn btn-primary">ğŸ² ìƒˆ ê²Œì„ ì‹œì‘</button>
            </div>
        </div>

        <div id="card-encyclopedia" class="hidden">
            <h2>ì¹´ë“œ ë„ê°</h2>
            <div id="card-list"></div>
            <button id="close-encyclopedia" class="btn btn-secondary">ë‹«ê¸°</button>
        </div>

        <footer>
            <p>Runs with <strong>ONNX Runtime Web</strong> (WASM Endpoint)</p>
        </footer>
    </div>

    <!-- ìˆœì„œ ì¤‘ìš”: ì¢…ì†ì„± -->
    <script src="js/cards.js"></script>
    <script src="js/board.js"></script>
    <script src="js/ui.js"></script>
    
    <!-- ONNX Agent -->
    <script src="js/onnx_agent.js"></script>

    <script>
        // Main Logic (Simplified for ONNX only)
        let playUI, playGame, agent;
        let selectedPiece = null;
        let selectedCard = null;
        let possibleMoves = [];

        async function init() {
            const loading = document.getElementById('loading-overlay');
            loading.classList.remove('hidden');

            playUI = new OnitamaUI('canvas-play');
            playGame = new OnitamaGame();
            
            // ONNX Agent ì´ˆê¸°í™”
            agent = new OnitamaOnnxAgent();
            const success = await agent.load('./onitama-actor.onnx'); // ìƒëŒ€ ê²½ë¡œë¡œ ìˆ˜ì •
            
            loading.classList.add('hidden');

            if (!success) {
                alert('ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨! index.html(í•™ìŠµë²„ì „)ìœ¼ë¡œ ì´ë™í•˜ê±°ë‚˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                return;
            }

            // ê²Œì„ ì‹œì‘
            startNewGame();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();

            // ì¹´ë“œ ë„ê° ì´ˆê¸°í™”
            playUI.setupCardEncyclopedia(getAllCards());
        }

        function startNewGame() {
            playGame.reset();
            updateUI();
            selectedPiece = null;
            selectedCard = null;
            possibleMoves = [];
            document.getElementById('turn-indicator').textContent = "ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤ (Red)";
        }

        function updateUI() {
            playUI.drawBoard(playGame);
            playUI.renderCards(playGame, true);
        }

        function setupEventListeners() {
            document.getElementById('btn-new-game').onclick = startNewGame;

            // ì¹´ë“œ í´ë¦­
            document.addEventListener('click', (e) => {
                const cardEl = e.target.closest('.card');
                if (cardEl && cardEl.closest('#player-cards')) {
                    if (playGame.gameOver || playGame.currentPlayer !== 1) return;

                    const cards = Array.from(document.querySelectorAll('#player-cards .card'));
                    const cardIdx = cards.indexOf(cardEl);
                    if (cardIdx !== -1) selectCard(cardIdx);
                }
            });

            // ìº”ë²„ìŠ¤ í´ë¦­ (ë³´ë“œ)
            document.getElementById('canvas-play').onclick = handleBoardClick;
        }

        function selectCard(cardIdx) {
            selectedCard = cardIdx;
            
            // UI í•˜ì´ë¼ì´íŠ¸
            document.querySelectorAll('#player-cards .card').forEach(c => c.classList.remove('selected'));
            const cards = document.querySelectorAll('#player-cards .card');
            if (cards[cardIdx]) cards[cardIdx].classList.add('selected');
            
            if (selectedPiece) updatePossibleMoves();
        }

        function handleBoardClick(e) {
            if (playGame.gameOver) return;
            if (playGame.currentPlayer !== 1) return; // AI í„´ ë°©ì§€

            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const pos = playUI.getBoardPosition(x, y);
            
            if (!pos) return;
            const [clickX, clickY] = pos;

            // ë‚´ ë§ ì„ íƒ
            if (!selectedPiece) {
                const piece = playGame.board[clickY][clickX];
                if (piece > 0) { // Red Piece
                    selectedPiece = [clickX, clickY];
                    playUI.drawBoard(playGame);
                    playUI.drawHighlight(clickX, clickY);
                    if (selectedCard !== null) updatePossibleMoves();
                }
            } else {
                // ì´ë™ ì‹œë„
                if (selectedCard === null) {
                    alert('ë¨¼ì € ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”!');
                    return;
                }

                const isValidMove = possibleMoves.some(([mx, my]) => mx === clickX && my === clickY);

                if (isValidMove) {
                    executeMove({
                        from: selectedPiece,
                        to: [clickX, clickY],
                        cardIdx: selectedCard
                    });
                } else {
                    // ë‹¤ë¥¸ ë§ ì„ íƒ or ì·¨ì†Œ
                    const piece = playGame.board[clickY][clickX];
                    if (piece > 0) {
                        selectedPiece = [clickX, clickY];
                        updatePossibleMoves();
                    } else {
                        selectedPiece = null;
                        selectedCard = null;
                        possibleMoves = [];
                        updateUI();
                    }
                }
            }
        }

        function updatePossibleMoves() {
            possibleMoves = [];
            if (!selectedPiece || selectedCard === null) return;
            
            const [px, py] = selectedPiece;
            const cardId = playGame.redCards[selectedCard];
            const card = getCard(cardId);
            
            card.moves.forEach(([dx, dy]) => {
                const newX = px + dx;
                const newY = py + dy;
                if (newX >= 0 && newX < 5 && newY >= 0 && newY < 5) {
                    if (playGame.board[newY][newX] <= 0) { // ë¹ˆì¹¸(-1) or ì êµ°(-1, -2)
                        possibleMoves.push([newX, newY]);
                    }
                }
            });

            playUI.drawBoard(playGame);
            playUI.drawHighlight(selectedPiece[0], selectedPiece[1]);
            possibleMoves.forEach(([x, y]) => playUI.drawMoveIndicator(x, y));
        }

        async function executeMove(action) {
            playGame.makeMove(action);
            
            // ìƒíƒœ ì´ˆê¸°í™”
            selectedPiece = null;
            selectedCard = null;
            possibleMoves = [];
            updateUI();

            if (checkGameOver()) return;

            // AI í„´
            document.getElementById('turn-indicator').textContent = "AI ìƒê° ì¤‘... (Blue)";
            
            // í™”ë©´ ë Œë”ë§ì„ ìœ„í•´ ì ì‹œ ëŒ€ê¸°
            setTimeout(async () => {
                const aiAction = await agent.selectAction(playGame);
                
                if (aiAction) {
                    playGame.makeMove(aiAction);
                    updateUI();
                    if (checkGameOver()) return;
                } else {
                    alert("AI ê¸°ê¶Œ! ë‹¹ì‹ ì˜ ìŠ¹ë¦¬ì…ë‹ˆë‹¤.");
                }
                
                document.getElementById('turn-indicator').textContent = "ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤ (Red)";
            }, 100);
        }

        function checkGameOver() {
            if (playGame.gameOver) {
                setTimeout(() => {
                    if (playGame.winner === 1) alert('ğŸ† ìŠ¹ë¦¬!');
                    else if (playGame.winner === -1) alert('ğŸ˜¢ íŒ¨ë°°...');
                    else alert('ë¬´ìŠ¹ë¶€');
                }, 100);
                return true;
            }
            return false;
        }

        // ì‹œì‘
        window.onload = init;
    </script>
</body>
</html>
