<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onitama AI - Zen Strategy Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700;900&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- ONNX Runtime Web -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        .onnx-badge {
            background-color: #6f42c1;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            vertical-align: middle;
            margin-left: 10px;
        }
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5em;
            z-index: 1000;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="game-notice" class="hidden"></div>
    <div id="loading-overlay" class="hidden">
        AI ëª¨ë¸ ë¡œë”© ì¤‘... ğŸ¤–
    </div>

    <div class="container">
        <header>
            <h1>ğŸ¥‹ ì˜¤ë‹ˆíƒ€ë§ˆ AI</h1>
            <p class="subtitle">ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤ë©´ ìƒˆ ê²Œì„ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”</p> <!-- Updated subtitle -->
        </header>

        <div id="panel-play" class="panel">
            <div class="game-layout">
                <!-- ì™¼ìª½: ë³´ë“œ ì˜ì—­ -->
                <div class="board-section">
                    <div class="game-area">
                        <canvas id="canvas-play" width="500" height="500"></canvas>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ì •ë³´ ë° ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
                <div class="info-section">
                    <div class="ai-cards-section hidden">
                        <div id="ai-cards" class="player-cards">
                            <div class="card-label">AI ì¹´ë“œ</div>
                            <div class="cards-holder"></div>
                        </div>
                    </div>

                    <div class="status-card">
                        <div id="turn-indicator">ê²Œì„ ì¤€ë¹„ ì¤‘...</div>

                        <div class="center-card-wrapper">
                            <div class="card-label">ì¤‘ì•™ ì¹´ë“œ</div>
                            <div id="center-card"></div>
                        </div>
                    </div>

                    <div class="player-cards-section">
                        <div id="player-cards" class="player-cards">
                            <div class="card-label">ë‚´ ì¹´ë“œ (í´ë¦­í•˜ì—¬ ì„ íƒ)</div>
                            <div class="cards-holder"></div>
                        </div>
                    </div>

                    <div class="controls-section">
                        <div class="help-text">
                            âŒ¨ï¸ <strong>f</strong>: ì¹´ë“œ ëª©ë¡ í† ê¸€<br>
                            1ï¸âƒ£ ì¹´ë“œ ì„ íƒ â†’ 2ï¸âƒ£ ë§ ì„ íƒ â†’ 3ï¸âƒ£ ì´ë™
                        </div>
                        <button id="btn-new-game" class="btn btn-primary">ğŸ² ìƒˆ ê²Œì„ ì‹œì‘</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="card-encyclopedia" class="hidden">
        <h2>ì¹´ë“œ ë„ê°</h2>
        <div id="card-list"></div>
        <button id="close-encyclopedia" class="btn btn-secondary">ë‹«ê¸°</button>
    </div>



    <!-- ìˆœì„œ ì¤‘ìš”: ì¢…ì†ì„± -->
    <script src="js/cards.js"></script>
    <script src="js/board.js"></script>
    <script src="js/ui.js"></script>
    
    <!-- ONNX Agent -->
    <script src="js/onnx_agent.js"></script>

    <script>
        // Main Logic (Simplified for ONNX only)
        let playUI, playGame, agent;
        let selectedPiece = null;
        let selectedCard = null;
        let possibleMoves = [];

        async function init() {
            const loading = document.getElementById('loading-overlay');
            loading.classList.remove('hidden');

            playUI = new OnitamaUI('canvas-play');
            playGame = new OnitamaGame();
            
            // ONNX Agent ì´ˆê¸°í™”
            agent = new OnitamaOnnxAgent();
            const success = await agent.load('./onitama-actor.onnx'); // ìƒëŒ€ ê²½ë¡œë¡œ ìˆ˜ì •
            
            loading.classList.add('hidden');

            if (!success) {
                alert('ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨! index.html(í•™ìŠµë²„ì „)ìœ¼ë¡œ ì´ë™í•˜ê±°ë‚˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                return;
            }

            // ê²Œì„ ì‹œì‘
            startNewGame();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();

            // ì¹´ë“œ ë„ê° ì´ˆê¸°í™”
            playUI.setupCardEncyclopedia(getAllCards());
        }

        function startNewGame() {
            playGame.reset();
            selectedPiece = null;
            selectedCard = null;
            possibleMoves = [];
            
            updateUI();
            
            // ë§Œì•½ ì²« í„´ì´ AI(Blue, -1)ë¼ë©´ ì¦‰ì‹œ íŠ¸ë¦¬ê±°
            if (playGame.currentPlayer === -1) {
                triggerAITurn();
            }
        }

        function updateUI(aiSelectedCard = null) {
            playUI.drawBoard(playGame);
            playUI.renderCards(playGame, true, selectedCard, aiSelectedCard);
            
            // í„´ ì¸ë””ì¼€ì´í„° í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const indicator = document.getElementById('turn-indicator');
            if (playGame.gameOver) {
                indicator.textContent = "ê²Œì„ ì¢…ë£Œ";
            } else {
                indicator.textContent = playGame.currentPlayer === 1 ? "ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤ (Red)" : "AI ìƒê° ì¤‘... (Blue)";
            }
        }



        function setupEventListeners() {
            document.getElementById('btn-new-game').onclick = startNewGame;

            // ì¹´ë“œ í´ë¦­ (ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ìœ¼ë¡œ ë” ê²¬ê³ í•˜ê²Œ ë³€ê²½)
            document.addEventListener('click', (e) => {
                const cardEl = e.target.closest('.card');
                if (!cardEl) return;

                // ë‚´ ì¹´ë“œ ì˜ì—­ì¸ ê²½ìš°ì—ë§Œ ì²˜ë¦¬
                if (cardEl.closest('#player-cards')) {
                    if (playGame.gameOver || playGame.currentPlayer !== 1) return;
                    
                    const holder = document.querySelector('#player-cards .cards-holder');
                    const cards = Array.from(holder.querySelectorAll('.card'));
                    const cardIdx = cards.indexOf(cardEl);
                    if (cardIdx !== -1) selectCard(cardIdx);
                }
            });

            // ìº”ë²„ìŠ¤ í´ë¦­ (ë³´ë“œ)
            document.getElementById('canvas-play').onclick = handleBoardClick;
        }

        function selectCard(cardIdx) {
            selectedCard = cardIdx;
            updateUI();
            if (selectedPiece) updatePossibleMoves();
        }


        function handleBoardClick(e) {
            if (playGame.gameOver) return;
            if (playGame.currentPlayer !== 1) return; // AI í„´ ë°©ì§€

            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const pos = playUI.getBoardPosition(x, y);
            
            if (!pos) return;
            const [clickX, clickY] = pos;

            // ë‚´ ë§ ì„ íƒ
            if (!selectedPiece) {
                const piece = playGame.board[clickY][clickX];
                if (piece > 0) { // Red Piece
                    selectedPiece = [clickX, clickY];
                    playUI.drawBoard(playGame);
                    playUI.drawHighlight(clickX, clickY);
                    if (selectedCard !== null) updatePossibleMoves();
                }
            } else {
                // ì´ë™ ì‹œë„
                if (selectedCard === null) {
                    playUI.showNotice('ë¨¼ì € ì‚¬ìš©í•  ë¬´ìˆ  ì¹´ë“œë¥¼ ì„ íƒí•˜ì‹­ì‹œì˜¤.');
                    return;
                }


                const isValidMove = possibleMoves.some(([mx, my]) => mx === clickX && my === clickY);

                if (isValidMove) {
                    executeMove({
                        from: selectedPiece,
                        to: [clickX, clickY],
                        cardIdx: selectedCard
                    });
                } else {
                    // ë‹¤ë¥¸ ë§ ì„ íƒ or ì·¨ì†Œ
                    const piece = playGame.board[clickY][clickX];
                    if (piece > 0) {
                        selectedPiece = [clickX, clickY];
                        updatePossibleMoves();
                    } else {
                        selectedPiece = null;
                        selectedCard = null;
                        possibleMoves = [];
                        updateUI();
                    }
                }
            }
        }

        function updatePossibleMoves() {
            possibleMoves = [];
            if (!selectedPiece || selectedCard === null) return;
            
            const [px, py] = selectedPiece;
            const cardId = playGame.redCards[selectedCard];
            const card = getCard(cardId);
            
            card.moves.forEach(([dx, dy]) => {
                const newX = px + dx;
                const newY = py + dy;
                if (newX >= 0 && newX < 5 && newY >= 0 && newY < 5) {
                    if (playGame.board[newY][newX] <= 0) { // ë¹ˆì¹¸(-1) or ì êµ°(-1, -2)
                        possibleMoves.push([newX, newY]);
                    }
                }
            });

            playUI.drawBoard(playGame);
            playUI.drawHighlight(selectedPiece[0], selectedPiece[1]);
            possibleMoves.forEach(([x, y]) => playUI.drawMoveIndicator(x, y));
        }

        async function executeMove(action) {
            playGame.makeMove(action);
            
            // ìƒíƒœ ì´ˆê¸°í™”
            selectedPiece = null;
            selectedCard = null;
            possibleMoves = [];
            updateUI();

            if (checkGameOver()) return;

            // AI í„´ íŠ¸ë¦¬ê±°
            await triggerAITurn();
        }

        async function triggerAITurn() {
            if (playGame.gameOver || playGame.currentPlayer !== -1) return;

            // í™”ë©´ ë Œë”ë§ì„ ìœ„í•´ ì ì‹œ ëŒ€ê¸°
            setTimeout(async () => {
                const aiAction = await agent.selectAction(playGame);
                
                if (aiAction) {
                    // AIê°€ ì„ íƒí•œ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸ (ì‹œê°ì  í”¼ë“œë°±)
                    updateUI(aiAction.cardIdx);
                    
                    // ì‚¬ìš©ìê°€ AIì˜ ì„ íƒì„ ì¸ì§€í•  ìˆ˜ ìˆë„ë¡ ì¶”ê°€ ë”œë ˆì´
                    await new Promise(resolve => setTimeout(resolve, 1200));
                    
                    playGame.makeMove(aiAction);
                    updateUI();
                    checkGameOver();
                } else {
                    alert("AI ê¸°ê¶Œ! ë‹¹ì‹ ì˜ ìŠ¹ë¦¬ì…ë‹ˆë‹¤.");
                }
            }, 800);
        }

        function checkGameOver() {
            if (playGame.gameOver) {
                setTimeout(() => {
                    if (playGame.winner === 1) alert('ğŸ† ìŠ¹ë¦¬!');
                    else if (playGame.winner === -1) alert('ğŸ˜¢ íŒ¨ë°°...');
                    else alert('ë¬´ìŠ¹ë¶€');
                }, 100);
                return true;
            }
            return false;
        }

        // ì‹œì‘
        window.onload = init;
    </script>
</body>
</html>
